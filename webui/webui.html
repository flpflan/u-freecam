<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>UMod Config</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f5f6f7;
  margin: 0;
  padding: 12px;
}

.panel {
  max-width: 960px;
  margin: auto;
  background: #fff;
  padding: 12px;
  border-radius: 6px;
}

h1 {
  font-size: 18px;
  margin: 0 0 8px;
}

#status {
  font-size: 12px;
  margin-bottom: 8px;
  color: #666;
}

.row {
  display: grid;
  grid-template-columns: 160px 1fr auto;
  gap: 6px;
  align-items: center;
  margin-bottom: 6px;
}

.row label {
  font-size: 13px;
}

/* small { */
/*   grid-column: 2 / -1; */
/*   font-size: 11px; */
/*   color: #888; */
/* } */

input, select {
  font-size: 13px;
  padding: 4px 6px;
  width: 100%;
}

/* input[type="checkbox"] {} */

.inline {
  display: flex;
  gap: 6px;
  align-items: center;
}

.object {
  border-left: 2px solid #ddd;
  margin-left: 8px;
  padding-left: 8px;
  margin-bottom: 6px;
}

.array-item {
  display: flex;
  gap: 6px;
  margin-bottom: 4px;
}

button {
  font-size: 12px;
  padding: 2px 6px;
  cursor: pointer;
}

.footer {
  text-align: right;
  margin-top: 12px;
}
</style>
</head>

<body>
<div class="panel">
  <h1>UMod 配置</h1>
  <div id="status">初始化中…</div>
  <div id="form"></div>
  <div class="footer">
    <button onclick="document.getElementById('importer').click()">
      <input id="importer" type="file" accept=".json" onchange="importConfig(event.target.files[0])" style="display: none;" />
      <span>从本地导入</span>
    </button>
    <button onclick="exportConfig()">保存到本地</button>
  </div>
</div>

<script>
/* =============== 全局配置 ================ */

const API = {
  config: "/config",
  schema: "/config/schema",
  syncIntervalMs: 3000
};

/* ================= 状态 ================= */

let schema = {};
let config = {};
let dirty = false;
let syncing = false;

/* ================= 工具 ================= */

function setStatus(text) {
  document.getElementById("status").textContent = text;
}

function deepClone(obj) {
  return JSON.parse(JSON.stringify(obj));
}

function deepEqual(a, b) {
  return JSON.stringify(a) === JSON.stringify(b);
}

/* ================= 加载 ================= */

async function loadSchema() {
  schema = await fetch(API.schema).then(r => r.json());
}

async function loadConfig(remote = false) {
  if (dirty && remote) return;

  const data = await fetch(API.config).then(r => r.json());
  if(!deepEqual(data, config)) {
    config = deepClone(data);
    render();
    setStatus("已同步");
  }
}

async function init() {
  await loadSchema();
  await loadConfig();
  setInterval(() => loadConfig(true), API.syncIntervalMs);
}

init();

/* ================= 渲染 ================= */

function render() {
  const root = document.getElementById("form");
  root.innerHTML = "";
  renderObject(root, schema, config, []);
}

function renderObject(container, schemaObj, dataObj, path) {
  for (const key in schemaObj) {
    renderField(container, key, schemaObj[key], dataObj[key], path.concat(key));
  }
}

function renderField(container, key, meta, value, path) {
  const name = meta?.label === undefined ? key : meta.label;
  const desc = meta?.desc === undefined ? "" : meta.desc;

  if (meta.type === "object") {
    const div = document.createElement("div");
    div.className = "object";
    div.innerHTML = `<strong title="${desc}">${name}</strong>`;
    renderObject(div, meta.properties, value || {}, path);
    container.appendChild(div);
    return;
  }

  if (meta.type === "array") {
    const div = document.createElement("div");
    div.className = "object";
    div.innerHTML = `<strong title="${desc}">${name}</strong>`;

    (value || []).forEach((v, i) => {
      const row = document.createElement("div");
      row.className = "array-item";
      row.appendChild(makeInput(meta.items, v, path.concat(i)));
      const del = document.createElement("button");
      del.textContent = "×";
      del.onclick = () => {
        value.splice(i, 1);
        markDirty();
        render();
      };
      row.appendChild(del);
      div.appendChild(row);
    });

    const add = document.createElement("button");
    add.textContent = "+ 添加";
    add.onclick = () => {
      value.push(defaultValue(meta.items));
      markDirty();
      render();
    };

    div.appendChild(add);
    container.appendChild(div);
    return;
  }

  const row = document.createElement("div");
  row.className = "row";

  const label = document.createElement("label");
  label.textContent = name;
  label.title = desc;
  row.appendChild(label);

  row.appendChild(makeInput(meta, value, path));

  container.appendChild(row);

  // if (meta.desc) {
  //   const desc = document.createElement("small");
  //   desc.textContent = meta.desc;
  //   row.appendChild(desc);
  // }
}

function makeInput(meta, value, path) {
  let el;

  if (meta.type === "enum") {
    el = document.createElement("select");
    meta.values.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      el.appendChild(o);
    });
    el.value = value;
    el.onchange = () => update(path, el.value);
    return el;
  }

  if (meta.type === "range") {
    const wrap = document.createElement("div");
    wrap.className = "inline";

    const r = document.createElement("input");
    r.type = "range";
    r.min = meta.min;
    r.max = meta.max;
    r.step = meta.step || 1;
    r.value = value;

    const n = document.createElement("input");
    n.type = "number";
    n.value = value;

    r.oninput = () => {
      n.value = r.value;
      update(path, Number(r.value));
    };

    n.onchange = () => {
      r.value = n.value;
      update(path, Number(n.value));
    };

    wrap.append(r, n);
    return wrap;
  }

  if (meta.type === "bool") {
    el = document.createElement("input");
    el.type = "checkbox";
    el.checked = value;
    el.onchange = () => update(path, el.checked);
    return el;
  }

  el = document.createElement("input");
  el.type = meta.type === "number" ? "number" : "text";
  el.value = value;
  el.onchange = () => update(path, meta.type === "number" ? Number(el.value) : el.value);
  return el;
}

/* ================= 数据修改 ================= */

function update(path, val) {
  let obj = config;
  for (let i = 0; i < path.length - 1; i++) obj = obj[path[i]];
  obj[path[path.length - 1]] = val;
  markDirty();
}

function markDirty() {
  dirty = true;
  setStatus("本地修改，未保存");
  // TODO
  submitConfig()
}

/* ================= 默认值 ================= */

function defaultValue(meta) {
  if (meta.type === "number" || meta.type === "range") return meta.min ?? 0;
  if (meta.type === "string") return "";
  if (meta.type === "bool") return false;
  if (meta.type === "enum") return meta.values[0];
  if (meta.type === "object") return {};
  if (meta.type === "array") return [];
}

/* ================= 提交 ================= */

async function submitConfig() {
  setStatus("保存中…");
  try {
    await fetch(API.config, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(config)
    });
    dirty = false;
    setStatus("保存成功");
  } catch {
    setStatus("保存失败");
  }
}

/* ================ 本地同步 ================ */
function exportConfig(filename = "umod.config.json") {
  try {
    const blob = new Blob([JSON.stringify(config)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');

    link.href = url;
    link.download = filename;

    document.body.appendChild(link);
    link.click();

    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    setStatus("导出成功");
  } catch (error) {
    console.error('导出失败:', error);
    setStatus("导出失败");
  }
}

function importConfig(file) {
  if(!file) return;

  try {
    const reader = new FileReader();

    reader.onload = function(e) {
      const content = e.target.result;
      const data = JSON.parse(content);
      markDirty();
      config = deepClone(data);
      setStatus("导入成功");
    }

    reader.readAsText(file);
  }
  catch (error) {
    console.error('导入失败:', error);
    setStatus("导入失败");
  };
}
</script>
</body>
</html>
