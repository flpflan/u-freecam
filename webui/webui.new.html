<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Service Config</title>

<style>
body {
  font-family: system-ui, sans-serif;
  max-width: 1000px;
  margin: 20px auto;
  padding: 0 12px;
}

h1 { margin-bottom: 12px; }

details {
  margin-left: 12px;
  border-left: 2px solid #ddd;
  padding-left: 8px;
}

summary {
  cursor: pointer;
  font-weight: 600;
  margin: 4px 0;
}

.row {
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 6px;
  align-items: center;
  margin: 2px 0;
}

label {
  font-family: monospace;
  white-space: nowrap;
}

input, select {
  width: 100%;
  padding: 2px 4px;
}

button.small {
  padding: 0 6px;
  font-size: 14px;
}

button.main {
  margin-top: 12px;
  padding: 6px 16px;
}

#status {
  margin-top: 6px;
  font-size: 13px;
  color: #666;
}
</style>
</head>

<body>
<h1>服务配置</h1>

<div id="form"></div>

<button class="main" id="save">保存配置</button>
<div id="status"></div>

<script>
const CONFIG_URL = "/config";
const SCHEMA_URL = "/config/schema";

let schema = {};
let currentConfig = {};
let editing = false;

/* ---------- utils ---------- */

const setStatus = t => document.getElementById("status").textContent = t;
const deepEqual = (a,b) => JSON.stringify(a) === JSON.stringify(b);

function markEditing(el) {
  el.addEventListener("focus", () => editing = true);
  el.addEventListener("blur", () => editing = false);
}

/* ---------- render ---------- */

function renderValue(key, value, path, inArray=false) {
  /* object */
  if (value !== null && typeof value === "object" && !Array.isArray(value)) {
    const d = document.createElement("details");
    d.open = true;

    const s = document.createElement("summary");
    s.textContent = key;
    d.appendChild(s);

    for (const [k,v] of Object.entries(value)) {
      d.appendChild(renderValue(k, v, path ? path+"."+k : k));
    }
    return d;
  }

  /* array */
  if (Array.isArray(value)) {
    const d = document.createElement("details");
    d.open = true;

    const s = document.createElement("summary");
    s.textContent = key + " [ ]";
    d.appendChild(s);

    value.forEach((item, i) => {
      d.appendChild(renderValue(i, item, path+"."+i, true));
    });

    const add = document.createElement("button");
    add.textContent = "+";
    add.className = "small";
    add.onclick = () => {
      value.push("");
      renderForm(currentConfig);
    };
    d.appendChild(add);
    return d;
  }

  /* primitive */
  const row = document.createElement("div");
  row.className = "row";

  const label = document.createElement("label");
  label.textContent = path;
  label.title = schema[path]?.desc ?? "";

  let input;
  const meta = schema[path];

  if (meta?.type === "enum") {
    input = document.createElement("select");
    meta.values.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      if (v === value) o.selected = true;
      input.appendChild(o);
    });
  } else {
    input = document.createElement("input");
    if (meta?.type === "bool" || typeof value === "boolean") {
      input.type = "checkbox";
      input.checked = value;
    } else if (meta?.type === "int" || typeof value === "number") {
      input.type = "number";
      input.value = value;
      if (meta?.min !== undefined) input.min = meta.min;
      if (meta?.max !== undefined) input.max = meta.max;
    } else {
      input.type = "text";
      input.value = value;
    }
  }

  input.dataset.path = path;
  markEditing(input);

  row.appendChild(label);
  row.appendChild(input);

  if (inArray) {
    const del = document.createElement("button");
    del.textContent = "×";
    del.className = "small";
    del.onclick = () => {
      deleteByPath(currentConfig, path);
      renderForm(currentConfig);
    };
    row.appendChild(del);
  }

  return row;
}

function renderForm(cfg) {
  const f = document.getElementById("form");
  f.innerHTML = "";
  for (const [k,v] of Object.entries(cfg)) {
    f.appendChild(renderValue(k, v, k));
  }
}

/* ---------- path helpers ---------- */

function setByPath(obj, path, value) {
  const ks = path.split(".");
  let cur = obj;
  ks.forEach((k,i) => {
    const key = isNaN(k) ? k : +k;
    if (i === ks.length-1) cur[key] = value;
    else {
      cur[key] ??= isNaN(ks[i+1]) ? {} : [];
      cur = cur[key];
    }
  });
}

function deleteByPath(obj, path) {
  const ks = path.split(".");
  let cur = obj;
  ks.forEach((k,i) => {
    const key = isNaN(k) ? k : +k;
    if (i === ks.length-1) {
      Array.isArray(cur) ? cur.splice(key,1) : delete cur[key];
    } else cur = cur[key];
  });
}

/* ---------- collect ---------- */

function collectForm() {
  const inputs = document.querySelectorAll("#form input, #form select");
  const r = {};
  inputs.forEach(i => {
    let v =
      i.type === "checkbox" ? i.checked :
      i.type === "number"   ? Number(i.value) :
      i.value;
    setByPath(r, i.dataset.path, v);
  });
  return r;
}

/* ---------- network ---------- */

async function loadAll() {
  try {
    const [s, c] = await Promise.all([
      fetch(SCHEMA_URL).then(r=>r.json()),
      fetch(CONFIG_URL, {cache:"no-store"}).then(r=>r.json())
    ]);
    schema = s;
    currentConfig = c;
    renderForm(c);
    setStatus("配置已加载");
  } catch {
    setStatus("加载失败");
  }
}

async function postConfig() {
  try {
    const cfg = collectForm();
    await fetch(CONFIG_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(cfg)
    });
    currentConfig = cfg;
    setStatus("配置已保存");
  } catch {
    setStatus("保存失败");
  }
}

/* ---------- init ---------- */

document.getElementById("save").onclick = postConfig;
loadAll();
</script>
</body>
</html>
